<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trip Planner - Final Report</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <style>
        /* 
         * CRITICAL: All CSS classes are documented and organized for easy maintenance
         * Sections: Layout, Components, Typography, Interactive, Responsive, Animations
         */
        
        /* ==============================================
         * LAYOUT STYLES - Core page structure
         * ============================================== */
        .bg-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .card {
            border: none;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        
        .section-card {
            background: linear-gradient(145deg, #f8f9ff, #e8ecff);
            border: 1px solid #e0e7ff;
            border-radius: 12px;
            transition: all 0.3s ease;
            margin-bottom: 1.5rem;
        }
        
        .section-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        /* ==============================================
         * MARKDOWN CONTENT STYLING - Dynamic content display
         * ============================================== */
        .markdown-content {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
        }
        
        /* Header hierarchy with consistent spacing */
        .markdown-content h1 {
            font-size: 2rem;
            font-weight: 700;
            color: #2d3748;
            margin: 1.5rem 0 1rem 0;
            padding-bottom: 0.5rem;
            border-bottom: 3px solid #667eea;
        }
        
        .markdown-content h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #4a5568;
            margin: 1.3rem 0 0.8rem 0;
            padding-left: 1rem;
            border-left: 4px solid #667eea;
        }
        
        .markdown-content h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #2d3748;
            margin: 1.1rem 0 0.6rem 0;
        }
        
        .markdown-content h4 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #4a5568;
            margin: 1rem 0 0.5rem 0;
        }
        
        .markdown-content h5, .markdown-content h6 {
            font-size: 1rem;
            font-weight: 600;
            color: #718096;
            margin: 0.8rem 0 0.4rem 0;
        }
        
        /* Text elements with proper spacing */
        .markdown-content p {
            margin-bottom: 1rem;
            color: #4a5568;
        }
        
        .markdown-content ul, .markdown-content ol {
            margin: 1rem 0;
            padding-left: 2rem;
        }
        
        .markdown-content li {
            margin-bottom: 0.5rem;
            color: #4a5568;
        }
        
        .markdown-content strong {
            font-weight: 600;
            color: #2d3748;
        }
        
        .markdown-content em {
            font-style: italic;
            color: #667eea;
        }
        
        /* ==============================================
         * TABLE STYLING - Enhanced for data presentation
         * ============================================== */
        .markdown-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
        }
        
        .markdown-content th {
            background: linear-gradient(145deg, #667eea, #764ba2);
            color: white;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .markdown-content td {
            padding: 12px 15px;
            border-bottom: 1px solid #e2e8f0;
            color: #4a5568;
        }
        
        .markdown-content tr:nth-child(even) {
            background-color: #f7fafc;
        }
        
        .markdown-content tr:hover {
            background-color: #edf2f7;
            transition: background-color 0.2s ease;
        }
        
        /* ==============================================
         * CODE AND SPECIAL ELEMENTS
         * ============================================== */
        .markdown-content code {
            background: #f1f5f9;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #e53e3e;
        }
        
        .markdown-content pre {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            margin: 1rem 0;
        }
        
        .markdown-content blockquote {
            border-left: 4px solid #667eea;
            margin: 1.5rem 0;
            padding: 1rem;
            background: #f7fafc;
            border-radius: 0 8px 8px 0;
            font-style: italic;
            color: #4a5568;
        }
        
        .markdown-content a {
            color: #667eea;
            text-decoration: none;
            border-bottom: 1px dotted #667eea;
            transition: all 0.2s ease;
        }
        
        .markdown-content a:hover {
            color: #764ba2;
            border-bottom-style: solid;
        }
        
        /* ==============================================
         * SECTION HEADERS WITH DYNAMIC ICONS
         * ============================================== */
        .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .section-icon {
            font-size: 1.5rem;
            color: #667eea;
            margin-right: 0.75rem;
            width: 2rem;
            text-align: center;
            flex-shrink: 0; /* Prevent icon shrinking */
        }
        
        .section-title {
            margin: 0;
            font-weight: bold;
            color: #2d3748;
            flex-grow: 1;
        }
        
        /* ==============================================
         * LOADING AND ERROR STATES
         * ============================================== */
        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 4px;
            height: 1rem;
            margin: 0.5rem 0;
        }
        
        .error-message {
            background: #fed7d7;
            border: 1px solid #feb2b2;
            color: #c53030;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        
        .empty-section {
            text-align: center;
            padding: 2rem;
            color: #a0aec0;
            font-style: italic;
        }
        
        /* ==============================================
         * RESPONSIVE DESIGN - Mobile first approach
         * ============================================== */
        @media (max-width: 768px) {
            .markdown-content h1 {
                font-size: 1.5rem;
            }
            
            .markdown-content h2 {
                font-size: 1.25rem;
                padding-left: 0.5rem;
            }
            
            .markdown-content table {
                font-size: 0.85rem;
            }
            
            .markdown-content th, .markdown-content td {
                padding: 8px 10px;
            }
            
            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .section-icon {
                margin-right: 0;
                margin-bottom: 0.25rem;
            }
        }
        
        /* ==============================================
         * ANIMATIONS AND TRANSITIONS
         * ============================================== */
        .animate-fade-in {
            animation: fadeIn 0.6s ease-in;
        }
        
        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* ==============================================
         * PRINT STYLES - Clean document printing
         * ============================================== */
        @media print {
            .bg-gradient { 
                background: white !important; 
            }
            .card { 
                box-shadow: none !important; 
            }
            .section-card { 
                break-inside: avoid; 
                border: 1px solid #ccc !important;
            }
            .navbar, .btn { 
                display: none !important; 
            }
        }
    </style>
</head>
<body class="bg-gradient">
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm mb-4">
        <div class="container">
            <a class="navbar-brand fw-bold text-primary" href="/">
                <i class="fa-solid fa-plane-departure me-2"></i>Trip Planner
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="#" onclick="TripReport.printReport()">
                    <i class="fa-solid fa-print me-1"></i>Print Report
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container py-4">
        <div class="row justify-content-center">
            <div class="col-lg-10 col-xl-8">
                <!-- Report Header Card -->
                <div class="card shadow-lg mb-4 animate-fade-in">
                    <div class="card-body text-center py-5">
                        <div class="mb-3">
                            <i class="fa-solid fa-map-location-dot fa-3x text-primary mb-3"></i>
                        </div>
                        <h1 class="card-title fw-bold text-primary mb-3">Your Personalized Trip Report</h1>
                        <div class="row text-center">
                            <div class="col-md-6">
                                <h5 class="text-muted mb-1">Destination</h5>
                                <h3 class="text-primary fw-bold" id="destination-display">
                                    {% if report and report.destination %}
                                        {{ report.destination }}
                                    {% else %}
                                        <span class="loading-skeleton" style="width: 150px; display: inline-block;"></span>
                                    {% endif %}
                                </h3>
                            </div>
                            <div class="col-md-6">
                                <h5 class="text-muted mb-1">Duration</h5>
                                <h3 class="text-success fw-bold" id="duration-display">
                                    {% if report and report.days %}
                                        {{ report.days }} Days
                                    {% else %}
                                        <span class="loading-skeleton" style="width: 100px; display: inline-block;"></span>
                                    {% endif %}
                                </h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Report Sections Container -->
                <div id="report-sections-container">
                    {% if report and report.sections %}
                        {% for section in report.sections %}
                        <div class="section-card animate-fade-in" data-section-id="{{ loop.index }}">
                            <div class="p-4">
                                <div class="section-header">
                                    <div class="section-icon" data-section-type="{{ section.type | default('default') }}">
                                        <!-- Icon will be set by JavaScript based on section type/title -->
                                    </div>
                                    <h3 class="section-title">{{ section.title | default('Untitled Section') }}</h3>
                                </div>
                                
                                <div class="markdown-content" 
                                     id="section-content-{{ loop.index }}"
                                     data-content-type="{{ section.content_type | default('markdown') }}"
                                     data-raw-content="{{ section.content | e }}">
                                    <!-- Content will be processed by JavaScript -->
                                    <div class="loading-skeleton"></div>
                                    <div class="loading-skeleton" style="width: 80%;"></div>
                                    <div class="loading-skeleton" style="width: 60%;"></div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <!-- Fallback for empty or missing sections -->
                        <div class="section-card">
                            <div class="empty-section">
                                <i class="fa-solid fa-circle-info fa-2x mb-3"></i>
                                <p>No report sections available. Please generate a new trip report.</p>
                            </div>
                        </div>
                    {% endif %}
                </div>

                <!-- Action Buttons -->
                <div class="text-center mt-4">
                    <a href="/" class="btn btn-primary btn-lg me-3">
                        <i class="fa-solid fa-plus me-2"></i>Plan Another Trip
                    </a>
                    <button class="btn btn-outline-primary btn-lg" onclick="TripReport.printReport()">
                        <i class="fa-solid fa-download me-2"></i>Save as PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        /**
         * TRIP REPORT MANAGER
         * 
         * This object handles all dynamic functionality for the trip report page.
         * It's organized into logical sections for easy maintenance and debugging.
         * 
         * CRITICAL: All methods are documented with clear parameter types and return values.
         * Any future developer can easily understand and modify this code.
         */
        const TripReport = {
            
            // Configuration object - modify these values to change behavior
            config: {
                animationDelay: 100, // milliseconds between section animations
                markdownOptions: {
                    breaks: true,
                    gfm: true,
                    tables: true,
                    sanitize: false
                },
                iconMappings: {
                    // Default icon mappings for section types
                    'overview': 'fa-info-circle',
                    'introduction': 'fa-info-circle',
                    'itinerary': 'fa-calendar-days',
                    'schedule': 'fa-calendar-days',
                    'day': 'fa-calendar-days',
                    'budget': 'fa-money-bill-wave',
                    'cost': 'fa-money-bill-wave',
                    'price': 'fa-money-bill-wave',
                    'weather': 'fa-cloud-sun',
                    'climate': 'fa-cloud-sun',
                    'transport': 'fa-car',
                    'travel': 'fa-car',
                    'food': 'fa-utensils',
                    'dining': 'fa-utensils',
                    'accommodation': 'fa-bed',
                    'hotel': 'fa-bed',
                    'activities': 'fa-camera',
                    'attractions': 'fa-camera',
                    'tips': 'fa-lightbulb',
                    'advice': 'fa-lightbulb',
                    'default': 'fa-circle-dot'
                }
            },

            /**
             * Initialize the trip report functionality
             * Called when the DOM is fully loaded
             */
            init() {
                try {
                    console.log('TripReport: Initializing...');
                    
                    // Configure markdown parser
                    this.setupMarkdown();
                    
                    // Process all sections
                    this.processSections();
                    
                    // Set up event listeners
                    this.setupEventListeners();
                    
                    // Apply animations
                    this.applyAnimations();
                    
                    console.log('TripReport: Initialization complete');
                } catch (error) {
                    console.error('TripReport: Initialization failed:', error);
                    this.showError('Failed to initialize report. Please refresh the page.');
                }
            },

            /**
             * Configure the markdown parser with our options
             */
            setupMarkdown() {
                if (typeof marked !== 'undefined') {
                    marked.setOptions(this.config.markdownOptions);
                } else {
                    console.warn('TripReport: Marked library not available');
                }
            },

            /**
             * Process all report sections and render their content
             */
            processSections() {
                const sections = document.querySelectorAll('[data-section-id]');
                console.log(`TripReport: Processing ${sections.length} sections`);

                sections.forEach((section, index) => {
                    try {
                        this.processSection(section, index);
                    } catch (error) {
                        console.error(`TripReport: Error processing section ${index + 1}:`, error);
                        this.showSectionError(section, 'Failed to load section content');
                    }
                });
            },

            /**
             * Process a single section
             * @param {Element} sectionElement - The section DOM element
             * @param {number} index - Section index for logging
             */
            processSection(sectionElement, index) {
                // Set section icon
                this.setSectionIcon(sectionElement);
                
                // Process section content
                const contentElement = sectionElement.querySelector('.markdown-content');
                if (contentElement) {
                    this.processContent(contentElement);
                }
            },

            /**
             * Set the appropriate icon for a section based on its type or title
             * @param {Element} sectionElement - The section DOM element
             */
            setSectionIcon(sectionElement) {
                const iconElement = sectionElement.querySelector('.section-icon');
                const sectionType = sectionElement.dataset.sectionType || 'default';
                const sectionTitle = sectionElement.querySelector('.section-title')?.textContent?.toLowerCase() || '';
                
                // Determine icon based on section type or title keywords
                let iconClass = this.config.iconMappings[sectionType];
                
                if (!iconClass) {
                    // Fall back to title-based detection
                    for (const [keyword, icon] of Object.entries(this.config.iconMappings)) {
                        if (sectionTitle.includes(keyword)) {
                            iconClass = icon;
                            break;
                        }
                    }
                }
                
                // Use default icon if no match found
                iconClass = iconClass || this.config.iconMappings.default;
                
                // Apply icon class
                if (iconElement) {
                    iconElement.innerHTML = `<i class="fa-solid ${iconClass}"></i>`;
                }
            },

            /**
             * Process and render content for a section
             * @param {Element} contentElement - The content container element
             */
            processContent(contentElement) {
                const rawContent = contentElement.dataset.rawContent;
                const contentType = contentElement.dataset.contentType || 'markdown';
                
                if (!rawContent) {
                    this.showEmptyContent(contentElement);
                    return;
                }

                try {
                    let processedContent;
                    
                    if (contentType === 'html' || rawContent.trim().startsWith('<')) {
                        // Content is already HTML
                        processedContent = rawContent;
                    } else {
                        // Process as markdown
                        if (typeof marked !== 'undefined') {
                            processedContent = marked.parse(rawContent);
                        } else {
                            // Fallback: treat as plain text with basic formatting
                            processedContent = `<p>${rawContent.replace(/\n/g, '<br>')}</p>`;
                        }
                    }
                    
                    contentElement.innerHTML = processedContent;
                    
                    // Post-process tables for responsiveness
                    this.makeTablesResponsive(contentElement);
                    
                } catch (error) {
                    console.error('TripReport: Content processing error:', error);
                    this.showContentError(contentElement, 'Failed to render content');
                }
            },

            /**
             * Make tables responsive by adding wrapper divs if needed
             * @param {Element} container - Container element to search for tables
             */
            makeTablesResponsive(container) {
                const tables = container.querySelectorAll('table');
                tables.forEach(table => {
                    if (!table.parentElement.classList.contains('table-responsive')) {
                        const wrapper = document.createElement('div');
                        wrapper.className = 'table-responsive';
                        table.parentNode.insertBefore(wrapper, table);
                        wrapper.appendChild(table);
                    }
                });
            },

            /**
             * Set up event listeners for interactive elements
             */
            setupEventListeners() {
                // Smooth scrolling for internal links
                document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                    anchor.addEventListener('click', (e) => {
                        e.preventDefault();
                        const targetId = anchor.getAttribute('href').substring(1);
                        const targetElement = document.getElementById(targetId);
                        if (targetElement) {
                            targetElement.scrollIntoView({
                                behavior: 'smooth',
                                block: 'start'
                            });
                        }
                    });
                });

                // Handle window resize for responsive tables
                window.addEventListener('resize', () => {
                    this.handleResize();
                });
            },

            /**
             * Handle window resize events
             */
            handleResize() {
                const tables = document.querySelectorAll('.markdown-content table');
                tables.forEach(table => {
                    if (table.offsetWidth > table.parentElement.offsetWidth) {
                        table.style.fontSize = '0.8rem';
                    } else {
                        table.style.fontSize = '';
                    }
                });
            },

            /**
             * Apply staggered animations to sections
             */
            applyAnimations() {
                const cards = document.querySelectorAll('.animate-fade-in');
                cards.forEach((card, index) => {
                    card.style.animationDelay = `${index * this.config.animationDelay}ms`;
                });
            },

            /**
             * Print the report with proper styling
             */
            printReport() {
                try {
                    // Hide elements that shouldn't be printed
                    const elementsToHide = [
                        ...document.querySelectorAll('nav'),
                        ...document.querySelectorAll('.btn'),
                        ...document.querySelectorAll('footer')
                    ];
                    
                    elementsToHide.forEach(el => {
                        if (el) el.style.display = 'none';
                    });
                    
                    // Print the document
                    window.print();
                    
                    // Restore hidden elements after a delay
                    setTimeout(() => {
                        elementsToHide.forEach(el => {
                            if (el) el.style.display = '';
                        });
                    }, 1000);
                    
                } catch (error) {
                    console.error('TripReport: Print error:', error);
                    alert('Error occurred while printing. Please try again.');
                }
            },

            /**
             * Show error message in the main container
             * @param {string} message - Error message to display
             */
            showError(message) {
                const container = document.getElementById('report-sections-container');
                if (container) {
                    container.innerHTML = `
                        <div class="error-message">
                            <i class="fa-solid fa-exclamation-triangle me-2"></i>
                            <strong>Error:</strong> ${message}
                        </div>
                    `;
                }
            },

            /**
             * Show error message for a specific section
             * @param {Element} sectionElement - The section element
             * @param {string} message - Error message to display
             */
            showSectionError(sectionElement, message) {
                const contentElement = sectionElement.querySelector('.markdown-content');
                if (contentElement) {
                    contentElement.innerHTML = `
                        <div class="error-message">
                            <i class="fa-solid fa-exclamation-triangle me-2"></i>
                            ${message}
                        </div>
                    `;
                }
            },

            /**
             * Show content error message
             * @param {Element} contentElement - The content element
             * @param {string} message - Error message to display
             */
            showContentError(contentElement, message) {
                contentElement.innerHTML = `
                    <div class="error-message">
                        <i class="fa-solid fa-exclamation-triangle me-2"></i>
                        ${message}
                    </div>
                `;
            },

            /**
             * Show message for empty content
             * @param {Element} contentElement - The content element
             */
            showEmptyContent(contentElement) {
                contentElement.innerHTML = `
                    <div class="empty-section">
                        <i class="fa-solid fa-circle-info me-2"></i>
                        No content available for this section.
                    </div>
                `;
            }
        };

        /**
         * INITIALIZATION
         * Start the application when DOM is ready
         */
        document.addEventListener('DOMContentLoaded', function() {
            TripReport.init();
        });

        /**
         * GLOBAL ERROR HANDLER
         * Catch any unhandled errors and log them
         */
        window.addEventListener('error', function(e) {
            console.error('TripReport: Unhandled error:', e.error);
        });

        /**
         * BACKWARD COMPATIBILITY
         * Keep the old function name for any existing references
         */
        function printReport() {
            TripReport.printReport();
        }
    </script>
</body>
</html>